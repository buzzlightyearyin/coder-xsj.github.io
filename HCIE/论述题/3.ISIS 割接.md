### ISIS 割接

#### 1. 拓扑图

![image-20211213231256062](https://s2.loli.net/2021/12/13/MqREVWay1gGFL6v.png)

#### 2. 题目

​	如图为某企业骨干网，R1、R2、R3、R4部署了IS-IS，根据ISIS生成的路由条目，实现总部和各分支之间的流量互通。 现在您需要进行设备割接，将R3由低性能设备替换成高性能设备，同时您需要尽可能保证业务不中断，请给出三种业务不中断的方案。

解决方案：

​	根据上述拓扑对现网概况进行充分调研，确保割接前期的需求分析、风险预案、割接方案等得到充分论证，然后根据割接方案进行割接。结合拓扑分析目前现网情况，在所有链路开销值一致的情况下，总部和分支之间互访流量应该会采用负载分担方式流经 `R2` 和 `R3`。

考虑该割接场景需要对 `R3` 设备进行替换，可以采用直接替换或逐步融入的方式进行上述割接的实现，为了防止业务中断，建议采用逐步融入的方式进行设备替换。

首先将新设备接入目前网络当中，然后正确配置接口 `IP` 以及 `ISIS` 相关配置，拓扑如下：

![image-20211213233324808](https://s2.loli.net/2021/12/13/MEJuAhaiZ7Fey9f.png)

目前路由器`ISIS` 配置完成之后，所有路由器仍然参与到转发，可以采用如下方案实现割接

方案一：设置 `R3` 的过载标识位 `OverLoad` 状态

​	设置 R3 的 `OverLoad-bit` 过载位之后，R3 产生 `ISIS LSP` 报文中的 `OverLoad-bit` 会置位，其它设备如 R1 和 R4 在进行 `SPF` 计算时不会使用 R3 做转发（除 R3 直连路由以外），从而暂时将 R3 从当前网络中隔离，业务流量不会在经过 R3 转发，设置过载位相应配置命令如下：

```sql
isis 1
	set-overload
```



方案二：修改与  `R3` 直连链路 `ISIS`开销值

​	假设默认情况下所有链路开销值默认为 `10`，针对上述拓扑可以将 `R4` 连接 `R3`、R1 连接 R3、R2 连接 R3 链路两端接口开销值修改为 50，修改完链路开销在 R1、R4 计算路由不会经过 R3，修改链路开销命令如下：

```sql
interfate GigabitEthernet0/0/0
	isis enable 1
	isis cost 50
```

需要主要的是，默认情况下 `ISIS` 度量值类型为 `narrow`，而如果前期部署已经将 `ISIS` 度量值类型修改为 `wide`，则可以选择其它较大开销值。而变更度量值类型会导致路由无法计算，现网环境需要谨慎配置。



方案三：修改 `R1` 和 `R4` 的下一跳权重

​	由于修改开销值涉及设备较多，可以直接在该等价负载分担场景下通过配置下一跳权重影响选路，相应命令如下:

R1 和 R4 的 `ISIS` 进行配置

```sql
isis 1
	nexthop x.x.x.x weight 1
	# value越小则优先级越高，value是整数形式，取值范围是1～254。
```

注： x.x.x.x 为 R2 或者新路由器直连 R1、R4 接口地址，即 R1 或者 R4 路由下一跳地址。



方案四：通过策略路由影响数据转发从而实现切换

​	上述方案一和方案二都是影响控制层面路由表，而借助基于接口策略路由可以在路由表不调整的情况下直接影响数据转发。

​	在 R1 和 R4 连接各自网络接口下配置策略路由，进行数据转发重定向，将流量引流至 R2 或者新增路由器，相应配置命令如下：

```sql
traffic classifier C
	if-match acl 2000	// 此处 ACL 2000 可以根据业务网段自行定义
traffic behavior C
	redirect ip-nexthop x.x.x.x // x.x.x.x 为 R2 或者新路由器直连 R1、R4 接口地址
traffic policy C
	classifier C behavior C
interface  GigabitEthernet0/0/2
	traffic-policy C inbound
```

通过上述方案，从控制层面或者转发层面将流量引导至 R2 或者新增路由器，注意按照割接流程应进行充分业务测试，确保业务正常后将 R3 从现网移除，将相应割接材料提交并完成验收。

