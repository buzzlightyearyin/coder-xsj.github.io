### OSPF 园区网双出口

#### 1. 拓扑图

![](https://i.loli.net/2021/12/02/Dgednyrax16kBG8.png)

![image-20220225205703361](C:/Users/XuShengjin/AppData/Roaming/Typora/typora-user-images/image-20220225205703361.png)

#### 2. 题目1

​	合理规划OSPF区域，使得办公网络发生变化时服务器区域（R7）路由表不会发生变化，写出两种方案，请详细描述该方案？

##### 方案一：OSPF 多区域部署的方案

结合上述拓扑，OSPF 区域规划如下：

​	核心路由器和汇聚路由器之间所有链路部署在 AREA 0 骨干区域，

   汇聚路由器和办公网络接入路由器之间所有链路部署在 ARAE 10 区域，

   汇聚路由器和服务器网络接入路由器（AR7）之间链路部署在 AREA 20 区域。

为了实现办公网络发生变化时不会影响到服务器区域，可以通过如下方案实现: 

1、特殊区域

​	将服务器所在区域配置为特殊区域，考虑到后续可能会引入直连路由建议配置为 `Totally NSSA` 区域。

部署该方案之后所有域间明细路由、外部路由都不会进入 `NSSA` 区域，AR4 作为 ABR 会下发默认路由指导本区域设备访问域间和域外。

由于域间明细路由、外部路由都无法进入 `NSSA` 区域，本区域设备无法感知其它区域的路由变化。

AR4、AR7 特殊区域配置如下：

```sql
ospf 1
	area 20
		nssa no-summary
```

2、路由汇总

​	在 AR4 上将办公网络区域的路由进行域间汇总，汇总之后 AR4 作为 ABR 只会将汇总路由传递进服务器所在区域，需要注意的是需要保证汇总路由包含办公网络所有明细路由，因此需要考虑前期 ip 地址规划。

AR4 配置域间路由汇总命令如下：

```sql
ospf 1
	area 10
		abr-summar x.x.x.x y.y.y.y	// x.x.x.x 为汇总后的 ip 地址，y.y.y.y 为汇总后子网掩码
```

建议手工配置或生成自动指向 `NULL` 的黑洞路由，防止路由汇总导致环路问题。

------

##### 方案二：OSPF 多进程部署的方案

​	在 AR4 上部署 OSPF 多进程实现办公网络和服务器网络的隔离，此时 AR4 作为 ASBR 可以将服务器所在网络的路由引入进办公网络。考虑到办公网络的路由变化不能影响到 AR7，可以在 AR4 服务器网络所在进程中通告默认路由，无需将办公网络明细路由引入进服务器所在网络。

AR4 配置通告默认路由配置如下：

```SQL
ospf 2  // 服务器网络所在进程
	default-route-advertise
```

上述两种方案都可以满足要求，并且后续可以继续通过路由过滤和路由汇总进行相应的路由控制。

------

#### 3. 题目2

​	客户提出需求，R1和R2上使用静态路由（默认路由）访问外网，当网络正常时，所有流量经过R1出去，R2作为备份链路，请写出方案？

​	当前拓扑需要在 AR1 和 AR2 上通过 OSPF 下发默认路由|（引入静态路由），缺省情况下默认路由会以 `LSA-5` 形式在除特殊区域以外的整个自治系统泛洪。

​	此时可以通过如下方案影响外部路由选路：

##### 方案一：修改外部路由类型

​	由于外部路由对应的 `LSA-5` 存在两种度量值类型：`Type-1` 和 `Type-2`，其中 `Type-1` 类型外部路由进行路由计算时会优于 `Type-2` 类型外部路由。

​	考虑到缺省情况下外部路由的度量值类型为 `Type-2` ，为了流量优选 R1 访问外部，可以在 R1 配置下发默认路由命令的同时修改路由度量值类型为 `Type-1` 类型，具体配置命令如下：

```sql
ospf 1
	default-route-advertise type 1
```



------

##### 方案二：修改路由开销值

A：外部开销值修改

​	由于默认情况下 OSPF 下发默认路由|（引入静态路由）会以类型 `Type-2`  的 `LSA-5` 形式传递，类型 `Type-2`  的 `LSA-5` 进行选路比较的时候首先比较外部开销值，在 R2 配置如下命令修改外部开销值影响选路，将外部开销值改大：

```sql
ospf 1
	default-route-advertise cost 1000
```

引入静态路由时配置

```sql
ospf 1
	import-route static cost 1000
```

B: 内部开销值修改

​	假设 R1 和 R2 都通过相应命令下发默认路由|（引入静态路由），类型 `Type-2` 的 `LSA-5` 进行如下选路：

1. 比较时首先比较外部开销值，而外部开销值默认为 1
2. 然后继续比较内部开销值（去往 ASBR）

​	建议修改接入路由器 AR6 和汇聚路由器 AR4 、汇聚路由器 AR4 和 核心路由器 AR2 之间互联链路的开销值，配置如下：

以 AR4 为例：

```sql
interfate GigabitEthernet x/x/x
	ospf cost 100
```

​	上述方案成功部署之后，可以满足所有业务流量通过 R1 访问外部，但是考虑到当前网络拓扑中 R2 设备自身会通过本地配置的默认路由访问外部网络，为保证所有流量包括 R2 设备访问外部的流量都将 R1 作为出口，建议进行如下配置：         

​	首先：R1 配置默认路由指向 ISP 并通过 OSPF 下发默认路由，由于 R2 也配置了上述命令以实现备份，所以缺省情况下 R2 不会使用 R1 下发的 `LSA-5` 进行路由计算，需要在 R2 配置命令允许计算 R1 下发的默认路由，具体配置如下:

``` 
ospf 1
	default-route-advertise permit-calculate-other
```

​	其次：由于静态路由协议优先级为 60，要优于 OSPF 外部路由优先级 150，所以 R2 需要修改之前配置指向 ISP 的默认路由优先级，建议修改为 151，具体配置如下：

```sql
ip route-static 0.0.0.0 0.0.0.0 x.x.x.x preference 151  // x.x.x.x 为 ISP 接口地址
```

​	修改之后 R2 会优选 R1 通过 OSPF 下发默认路由，整个 OSPF 自治系统全部选择 R1 作为出口访问 ISP。

