### MPLS VPN RT 规划

#### 1. 拓扑图

![image-20211205125809869](https://s2.loli.net/2021/12/05/MwneS4tflbqcuvz.png)

#### 2. 题目1

​	企业使用MPLS VPN组网。现有两种业务：
视讯业务 “video"只需要分支2和总部通讯，语音”voip"业务需要分支之间和总部都能通讯。
分支2的RT如图部署，请使用图中规划的RT，设计PE1和PE3上的RT。(5分）

一、视讯业务 `Vedio` 的 `RT` 规划与 `VPN` 实例配置

​	因为视讯业务 `Vedio` 只需要分支 2 和总部通讯，根据分支 2 的 RT 值设置，部署总部 VPN 实例，具体配置命令如下：

```sql
ip vpn-instance VEDIO
	ipv4-family
  	route-distinguisher AA:N
  	vpn-target 100:100 export-extcommunity
  	vpn-target 100:101 import-extcommunity
```

可以实现分支 2 和总部 `VPNv4` 路由相互学习，并且路由加入到对应的 `VRF` 中。

二、语音业务 `Voip` 的 `RT` 规划与 `VPN` 实例配置

此规划语音业务互访的时候需要考虑两种情况：

场景一：处于安全的考虑分支之间 `Voip` 流量互访必须经过总部

可以考虑利用 `Hub-Spoke` 模型的 `VPN` 实现上述需求，具体配置命令如下：

A、分支 1 的 `RT` 和 `VPN` 实例具体配置命令如下：

```sql
ip vpn-instance VOIP
	ipv4-family
 		route-distinguisher AA:NN
  	vpn-target 200:100 export-extcommunity
  	vpn-target 200:101 import-extcommunity
```

B、总部的 `RT` 和 `VPN` 实例考虑 `Hub-Spoke` 模型需要创建两个 `VPN` 实例，具体配置如下：

```sql
ip vpn-instance VOIP-IN
	ipv4-family
  	route-distinguisher AA:NN
  	vpn-target 200:100 import-extcommunity
ip vpn-instance VOIP-OUT
 	ipv4-family
  	route-distinguisher AA:NN
  	vpn-target 200:101 export-extcommunity
```



场景二：分支之间的 `VOIP` 业务流量互访不需要经过总部

考虑延迟、抖动等因素分支之间的 `VOIP` 业务不需要经过总部，可以考虑利用全互联 `Full-mesh` 模型的 `VPN` 实现上述需求。

A、分支 1 的 `RT` 和 `VPN` 实例具体配置命令如下：

```sql
ip vpn-instance VOIP
	ipv4-family
 		route-distinguisher AA:NN
 		vpn-target 200:101 export-extcommunity
  	vpn-target 200:100 import-extcommunity
```

B、总部的 `RT` 和 `VPN` 实例考虑全互联模型只需要维护一个实例即可，具体配置命令如下：

```sql
ip vpn-instance VOIP
	ipv4-family
 		route-distinguisher AA:NN
 		vpn-target 200:101 export-extcommunity
  	vpn-target 200:100 import-extcommunity
```



------

#### 题目2

​	如若严格正确按照上述规划RT之后，分支1用户反应Voip or Vedio 业务可以和总部通讯，但是无法和分支2通讯，请分析可能的故障原 因（5分）

根据故障情况分析故障可能原因，从控制层面和转发层面两个角度分析故障可能：

1、路由控制层面

A、`IBGP` 对等体关系

​	首先排除是否存在 `VPNv4` 对等体无法建立故障，如果采用 `IBGP` 全互联，则通过 `display bgp vpnv4 all peer` 检查邻居关系，判断分支2 和 分支1 之间对等体关系是否建立。

​	由于采用 `IBGP` 建立对等体，`IBGP` 推荐使用环回口建立对等体，是否存在底层 `IGP` 故障导致环回口不可达，无法建立对等体。

B、`RR` 配置是否正确

​	如果采用 `RR` 路由反射器，则需要通过 `display current-configuration configuration bgp` 命令检查路由反射器客户端是否正确配置，因为如果 `RR` 路由反射器只是指定了总部 `PE` 作为 `VPNv4` 路由客户端，也会导致分支之间非客户端路由无法正确传递。

C、`VPN` 实例中存在特定路由过滤

​	可能因为特定路由过滤导致 `VPNv4` 路由无法加入相应的 `VRF` 当中，则需要放行对应路由。

```sql
ip vpn-instance A
	ipv4-family
		import route-policy Test
```

D、`Hub-Spoke` 模型的特殊配置

考虑上述场景可能采用 `Hub-Spoke` 模型，如果总部 `PE` 和 `CE` 之间运行 `EBGP`，则需要额外考虑允许 `as` 号重复 `allow-as-loop`。

E、PE 和 CE 之间引入路由执行过滤

​	分支1 需要将私网路由进行相应双向引入，可能由于路由过滤导致分支2 的路由没有引入进私网 `IGP`，可以在分支2 的 `CE` 设备检查路由表 `display ip routing-table` 验证路由引入。



2、MPLS 层面

​	由于 `MPLS-VPN` 需要建立 `MPLS LSP` 隧道保证私网流量可达，所以底层 `MPLS LSP` 出现故障也会导致路由无效，考虑分支1 和总部能够正常通信，排查 `LDP` 会话故障的可能，在分支1 的 `PE` 上通过 `display mpls lsp` 检查是否存在去往分支2 的 `PE` 的 `LSP` 隧道



3、数据转发层面

​	考虑到 `VOIP` 等语音流量通常基于 `UDP` 进行承载的，所以特定路由器如果过滤 `UDP` 流量也会导致 `VOIP` 无法正常通信。首先可以利用 `ping` 测试业务地址连通性，然后利用 `display acl all ` 检查是否存在基于 `VOIP`（UDP） 流量过滤，如果存在放行即可。

