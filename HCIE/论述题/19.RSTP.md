# RSTP

## 1. 拓扑

所有交换机都运行RSTP, SW1优先级4096，SW2优先级4096，SW3 优先级8192

![image-20220115154701997](https://s2.loli.net/2022/01/15/iTVPW2XocCjOU4D.png)

如上图所示，SW1 与 SW2的优先级相同均为4096,但是SW1 的 MAC地址小于SW2,且SW1连接SW2与SW1连接SW3的端口捆绑为eth-trunk,请回答以下问题

## 2. 题目 1

SW2 的3、4 接口是什么端口角色? (请分析过程) 3分

> 注意：考场题本描述SW2和SW3之间是否存在Eth-Trunk，此处先按没有做链路聚合分析

SW2 的 G0/0/2 和 G0/0/3 都为 `DP` 指定端口 。

在 RSTP 中，选举根桥、根端口和指定端口主要使用配置 `BPDU` 报文中的消息优先级向量（根桥 ID、根开销、发送端口 ID），详细分析如下：

1. 选举根桥

   交换机初始情况下都认为自身为根桥，会发送根桥 ID 为自身根桥 ID 的配置 `BPDU` 消息，通过比较根桥 ID 选举当前网络的根桥，比较过程如下：

   1. 比较网桥优先级，优先级最小的交换机会成为根桥
   2. 如果网桥优先级一致，然后比较网桥 MAC 地址，MAC 地址最小的交换机会成为根桥

   所以在当前拓扑中 SW1 会成为根桥

2. 选举根桥端口 RP

   每台非根网桥上都会选举唯一的根端口，根端口的选举会继续比较根路径开销 RPC、发送设备网桥 ID 和发送端口，比较过程如下：

   1. 累加接收到配置 BPDU 中的根路径开销，选取根路径开销最小的接口；
   2. 如果去往根桥的路径开销之和一致，则优选接收到配置 `BPDU` 发送设备网桥 ID 最小的接口；
   3. 如果上述条件都一致，则优选收到配置 `BPDU` 发送端口 ID 最小的接口；
   4. 如果上述条件都一致，则优选自身接收 `BPDU` 的端口 ID 最小的接口；

   所以在当前拓扑中 SW2 和 SW3 的 Eth-Trunk 接口作为根端口 RP。

3. 选举指定端口 DP

   指定端口 DP 作为向所在链路转发 `BPDU` 的最优接口，需要在每个链路选举唯一的指定端口，其比较过程仍然遵循上述 RP 比较原则。

   因此 SW2 和 SW3 之间的链路上由于两者去往根桥路径开销一致，通过比较 SW2 和 SW3 的发送设备网桥 ID 判断 SW2 是网桥 ID 更小的发送发设备，SW2 的 G0/0/3 和 G0/0/4 都为 DR 指定端口。

   最终 SW3 的 G0/0/3 和 G0/0/4 将会被阻塞，形成逻辑无环的拓扑。


## 问题 2

假设SW2的1号接口退出ETH-trunk1, SW2 的各个端口是什么角色以及状态? (请分析过程)7分。

> 变种一：如果Eth-Trunk采用手工方式

如果仅将 SW2 的 G0/0/1 退出 `Eth-Trunk1` 成为独立端口，SW1 的 1 号接口仍然属于 `Eth-Trunk` 成员接口，由于手工负载分担模式不会通过 `LACP` 协议协商接口状态，所有接口仍然可以进行数据转发，SW1 通过 `Eth-Trunk` 发送 BPDU 报文采用逐流的负载分担方式，根据负载分担方式不同，则可能出现两种情况：

1. 情况一：如果 BPDU 报文是从 SW1 的 G0/0/1 接口发送，SW2 的端口角色和端口状态如下：

   G0/0/1 端口角色为根端口 RP，端口状态为 `Forwarding`

   G0/0/2 接口为 `Eth-Trunk1` 成员端口为指定端 DP，端口状态为 `Forwarding`

   G0/0/3 接口为 AP 替代端口，端口状态为 `Discarding`

   G0/0/4 接口为 AP 替代端口，端口状态为 `Discarding`

2. 情况二：如果 BPDU 报文是从 SW1 的 G0/0/2 接口发送，SW2 的端口角色和端口状态如下：

   G0/0/1 接口为指定端口 DP，端口状态为 `Forwarding`

   G0/0/2 接口为 `Eth-Trunk1` 成员端口为 RP 根端口，端口状态为 `Forwarding`

   G0/0/3 接口为 AP 替代端口，端口状态为 `Discarding`

   G0/0/4 接口为 AP 替代端口，端口状态为 `Discarding`

STP 计算过程会比较配置 `BPDU` 优先级向量（根桥 ID、根路径开销、发送设备网桥 ID、发送端口 ID），完成端口角色的选举，上述端口角色及状态的详细过程如下：

1. 网桥 ID 最小的设备仍然为 SW1、所以 SW1 为根桥

2. 非根网桥选举端口

   当 SW2 的 G0/0/1 退出 `Eth-Trunk` 之后，SW2 需要选举唯一的根端口

   对于情况一：

   ​	SW1 逐流负载分担后， BPDU 报文通过 G0/0/1 接口发送，

   ​	SW2 的 G0/0/1 可以正常接收到 SW1 周期发送的最优 BPDU，该接口去往根桥路径开销最小，成为根端口 RP。

   ​	RSTP 情况下，该接口立刻进入 `Forwarding` 状态。

   对于情况二：

   ​	SW1 逐流负载分担后，BPDU 报文通过 G0/0/2 接口发送，

   ​	SW2 的 G0/0/2 可以正常收到 SW1 周期发送的最优 BPDU，该接口去往根路径开销最小，成为根端口 RP。

   ​	RSTP 情况下，该接口立刻进入 `Forwarding` 状态，不需要等待转发延时。

3. 链路选举指定端口 DP

   1. SW2 和 SW1 之间的链路

      对于情况一：

      ​	SW1 逐流负载分担后， BPDU 报文通过 G0/0/1 接口发送，

      ​	导致 SW2 的 G0/0/2 无法接收到 SW1 发送的最优 `BPDU`，超时计时器到期后， G0/0/2 接口成为指定端口 DP。

      ​	该接口首先会进行 `Discarding` 状态，等待两倍转发延时也就是 30s 之后，进入 `Forwarding` 状态。

      对于情况二：

      ​	SW2 逐流负载分担后， BPDU 报文通过 G0/0/2 接口发送，
   
      ​	导致 SW2 的 G0/0/1 无法接收到 SW1 发送的最优 `BPDU`，超时计时器到期后， G0/0/1 接口成为指定端口 DP。
   
      ​	该接口首先会进行 `Discarding` 状态，等待两倍转发延时也就是 30s 之后，进入 `Forwarding` 状态。
   
   2. SW2 和 SW3 之间的链路
   
      当 SW2 的 G0/0/1 退出 `Eth-Trunk` 之后，
   
      SW3 去往根桥 SW1 仍为聚合链路，链路带宽较高，SW2 去往根桥的开销要大于 SW3 去往根桥的路径开销，
   
      因此 SW3 的 G0/0/3 和 G0/0/4 接口成为指定端口 DP。
   
      而 SW2 的接口 G0/0/3 和 G0/0/4 接口成为 AP 替代端口，处于`Discarding` 状态。

> 变种二：如果Eth-Trunk采用LACP协议

如果仅将 SW2 的 1 号接口退出 `Eth-Trunk1`，则 SW2 的 1 号接口成为独立端口，SW1 的 1 号接口仍然属于 `Eth-trunk` 成员接口，LACP 协议会协商当前成员接口状态，协商失败后 SW1 会将 G0/0/1 接口置为 `UnSelect` 状态，SW1 和 SW2 通过 G0/0/1 相连链路无法正常转发数据，此时 SW2 的端口角色如下：

​	G0/0/1 接口为指定端口 DP，端口状态为 `Forwarding`

​	G0/0/2 接口为 `Eth-Trunk1` 成员端口为 RP 根端口，端口状态为 `Forwarding` 

​	G0/0/3 接口为 AP 替代端口，端口状态为 `Discarding` 

​	G0/0/4 接口为 AP 替代端口，端口状态为 `Discarding` 

​	STP 计算过程会比较 `BPDU` 优先级向量（根桥 ID、根路径开销，发送设备网桥 ID，发送端口 ID），完成端口角色的选举，上述端口角色及状态的详细过程如下：

1. 网桥 ID 最小的设备仍然为 SW1，所以 SW1 为根桥

2. 选举根端口 RP

   对于 SW2 而言，当 G0/0/1 退出 `Eth-Trunk` 之后，SW2 的 G0/0/2 仍然属于 `Eth-trunk`，可以正常接收到 SW1 周期发送的最优 `BPDU`，所以该接口成为 RP 根端口，RSTP 情况下，端口状态立即进入 `Forwarding` 状态，不需要	等待转发延时。

3. 选举指定端口 DP

   1. SW2 和 SW1 之间的链路

      当 SW2 的 G0/0/1 退出 `Eth-Trunk` 之后，因为 LACP 协商失败后 SW1 会将 G0/0/1 接口置为 `Unselect` 状态，该接口不会再发送 `BPDU` 等报文。

      SW2 的 G0/0/1 无法接收到 `BPDU` 报文，超时计时器到期后成为指定端口 DP，该接口首先会进入 `Discarding` 状态，等待两倍转发延时，也就是 30s 之后，进入 `Forwarding` 状态。

   2. SW2 和 SW3 之间的链路

      当 SW2 的 G0/0/1 接口 退出 `Eth-Trunk` 之后，SW3 去往根桥 SW1 仍然为聚合链路，链路带宽较高，SW2 去往根桥的开销要大于 SW3 去往根桥的开销，因此 SW3 将会作为指定交换机，SW3 的接口为指定端口 DP。而 SW2 的 G0/0/3 和 G0/0/4 端口成为非指定端口，端口角色为替代端口 AP，处于`Discarding` 状态。

