# 园区网安全 DHCP

## 1. 拓扑



## 2. 题目 1

​	园区网规划如图，网络中存在部分终端无法访问网关，并且存在大量ARP表项翻动，网络中还存在部分终端IP地址为169.254.X.X。请分析 可能原因，定位并排除故障。（5分）

针对部分网关无法访问网关，且存在大量 ARP 表项翻动，同时部分终端设备无法通过 DHCP 服务器正常获取 IP 地址。结合上述拓扑，分析可能原因、排障思路如下：

1. 物理层链路翻动导致故障

   如果交换机之间互连链路频繁 `up/down` 导致震荡的情况，可能会导致上述现象，可以通过设备日志信息快速判断是否存在链路翻动情况，上述故障可以通过替换线缆或者端口模块进行故障排除。

2. 欺骗攻击

   1. ARP 中间人攻击

      在网关设备上通过 `display arp all` 观察 ARP 表项，存在 ARP 表项翻动，初步判断存在 ARP 欺骗攻击，攻击者会伪造 ARP 应答消息，导致网关设备或其它终端频繁更新表项，数据流量错误发送至攻击者。

      上述攻击，可以通过 ARP 表项固化、ARP 严格学习、DAI 动态 ARP 检查等技术解决。

   2. 网关欺骗攻击

      在终端设备上通过 `arp -a` 观察网关设备对应的 ARP 表项，如果发现终端设备的 ARP 表项翻动，则考虑出现针对网关的欺骗攻击。

      上述攻击，可以通过 ARP 防网关冲突、网关发送免费 ARP 等技术解决。

   3. DHCP 服务器欺骗攻击

      可能存在攻击者仿冒 DHCP 服务器，导致客户端无法通过合法服务器正确获得 IP 地址。

      上述攻击可以利用 `DHCP Snooping` 的信任功能，配置连接合法的 `DHCP Server` 的接口为信任接口即可。

3. 泛洪攻击

   1. ARP 泛洪攻击

      可以在网关设备上通过 `display cpu-defend statistics packet-type arp-request / arp-reply all` 命令观察是否存在大量 ARP 报文丢弃。若存在大量 ARP 报文丢弃，说明存在 ARP 泛洪攻击导致无法通信。

      上述攻击可以通过配置 ARP 报文限速来解决，而如果针对 ARP 表项空间的攻击则可以通过 ARP 表现限制解决。

   2. DHCP 报文泛洪攻击

      如果存在攻击者伪造大量 DHCP Discover 消息，DHCP Rquest 消息，也会造成交换机无法处理合法报文的故障。我们可以通过 `display cpu-defend statistics packet-type dhcp-client` 观察是否存在大量 DHCP 报文被丢弃。

      上述攻击可以通过 `DHCP Snooping` 报文限速功能进行防范。

   3. DHCP 拒绝服务攻击

      存在 DHCP 饿死攻击，攻击者通过伪造 DHCP 请求消息中的 `CHADDR` 字段不断向 DHCP 服务器申请 IP 地址，导致服务器地址池被耗空，无法为合法用户分配地址。

      上述攻击可配置 `DHCP Snooping` 功能，限制端口允许接入的最大用户数量，同时开启 `DHCP Snooping` 检查 `CHADDR` 功能，防止非法接入。 

   4. TC 泛洪攻击

      上述拓扑中交换机接收到 TC 报文后，会执行 MAC 地址表项和 ARP 表项的删除操作，如果攻击者伪造 TC 消息并频繁发送，会导致交换机表项翻动，造成上述故障。

      上述攻击可以通过配置 STP TC 保护来进行防范。

4. 设备性能规格或者配置出现问题

   如果网络规模超出当前设备性能及表项空间规格， 也可能出现上述故障，则建议对设备进行升级。

   如果存在人为配置错误的可能，可以通过 `display history-command` 观察设备近期配置，如果存在该问题，建议对设备进行管理层面加固。

## 3. 题目 2

​	此园区网需要防止非法有线接入，请提供可行性方案。（5分）

考虑到上述园区网的拓扑设计和业务类型，针对该园区网网络的非法接入，主要从以下几个角度防范：

1. MAC 地址安全及端口安全

   接入交换机从 MAC 地址表层，针对部分固定 MAC 地址的攻击可以通过配置黑洞 MAC 地址条目来实现安全防护，另外配置端口安全然后通过 sticky 方式形成 MAC 地址条目，限制接口学习到的 MAC 地址条目数及保护行为，可以一定程度上防止非法客户端的接入。

2. DAI 动态 ARP 检测

   针对非法客户端接入后可能造成的 ARP 欺骗攻击，在开启了 `DHCP Snooping` 功能之后可以形成（IP、MAC、接口、VLAN） 的用户绑定表项，开启 DAI 动态 ARP 检测之后，借助形成的 `DHCP Snooping` 绑定表项完成对 ARP 消息的合法性检测，从而防止 ARP 中间人等欺骗攻击。 

3. IPSG IP 源防护

   针对非法客户端接入后造成的 IP 地址欺骗攻击，也可以在开启 `DHCP Snooping` 功能之后利用 `DHCP Snooping` 绑定表项进行 IP 报文的合法性检测，防止非法客户端静态修改 IP 地址，进行 IP 欺骗攻击等行为。

4. 边缘端口配合保护机制

   非法客户端接入后如果伪造 STP 报文，诸如 TC BPDU 也会导致整个交换网络因为拓扑变更而产生震荡，此时通过边缘端口的部署可以解决上述问题，边缘端口可以加速接口的收敛，同时不会因为端口状态迁移出发拓扑变更，配置 BPDU 防护等技术可以防范针对 STP 的恶意攻击。

5. NAC 网络接入控制

   上述攻击防范一定程度上可以避免非法接入者带来的攻击，但是无法彻底阻断非法接入，可以通过部署华为安全园区解决方案，利用 `imaster-NCE Campus` 产品结合交换机上 NAC 网络接入控制等技术，拒绝非法接入实现企业网络安全。

   该园区网络场景我们主要通过 `802.1x` 认证进行终端接入控制，终端设备安装 `802.1x` 客户端软件后，用户接入网络后接入交换机发起认证申请，接入交换机和用户终端交互信息后，把用户信息发送到认证服务器（如 Radius 服务器）进行认证，认证成功后接入交换机才会将相应接口作为授权接口。

   针对打印机等无法安装 `802.1x` 客户端的设备，采用 MAC 地址认证，接入交换机将把打印机的 MAC 地址作为用户名和密码上送到认证服务器进行认证，认证成功之后相应的打印机设备可以访问网络。

