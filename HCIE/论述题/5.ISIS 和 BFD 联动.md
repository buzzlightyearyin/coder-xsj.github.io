# ISIS 和 BFD 联动

## 1. 题目1

​	两台路由器通过跳纤直接相连，BFD for isis (detect-multiplier默认值为3，min-rx-interval和min-tx-interval都小于1s)，是否可以 缩短链路故障感知时间？（6分） 

答：正常情况下，可以通过 `BFD` 实现 `ms` 级别收敛

`ISIS` 的非 `DIS` 设备的 `hello` 时间间隔默认为 10s，`holdtime` 时间默认为 3 倍的 `hello` 时间，即为 30s。

若非直连设备链路故障，那么最多发现故障时间为：普通设备 30s，`DIS` 设备 9s。

依题意设置 `BFD`，最小接收 `BFD control` 间隔小于 1s，检测系数为 3 次，即 3s 内没有收到 `BFD control` 消息就能够检测到 `BFD session` 故障，从而联动 `ISIS` 邻居充值，加快故障感知。



但是路由器之间的 `ISIS` 网络类型为 `P2P`，且依题意通过跳纤相连，则要根据握手机制不同分开讨论。

情况一：光纤双向双芯故障，设备直连就物理 `down`，直接判断邻居故障，不需要 `BFD` 检测。

情况二：单芯故障

情况一则是 `3-way` 握手，同上，情况二则是 `2-way` 握手。

因为 `2-way` 握手机制中， `ISIS`	 设备只要收到邻居发来的有效 `hello` 报文，就能建立邻居，认为邻居状态为 `up`。就是 `BFD` 检测到双向通讯失败，也只能联动 `ISIS` 重置邻居，再重置邻居时，依旧会根据 `ISIS` 的机制建立邻居。

假设 R1、R2 通过跳纤相连，其中 `Link-1` 为 R1 发送给 R2 的链路，`Link-2` 为 R2 发送给 R1 的 链路，若其中跳线架之间的一条链路故障，另外一条正常，假设 `Link-1` 故障，`Link-2` 正常，那么 R2 通过 `BFD` 快速检测到双向转发故障，将 `BFD` 会话断掉，联动 `ISIS` 重置邻居，此时 R1 可以正常收到 R2 的 `hello` 报文，邻居状态迁移到 `up`，但是 R2 收不到 R1 发送的消息，邻居为 `down`，则 R1 不能检测到故障，但是 R2 可以。

情况三：如果邻居两端的接口是 `up` 的，但是由于使用过程中修改了光模块参数，导致的协商问题，通过 `BFD` 来快速感知链路故障，`ISIS` 也可以快速感知链路故障，泛洪新的 `LSP`，加快路由收敛。



## 2. 题目2

​	BFD的detect-multiplier 采用默认值3，是不是min-rx-interval 和min-tx-interval参数越小越好？如何合理的设置min-rx-interval 和 min-tx-interval的取值范围？（4分）

答：并不是参数越小越好。

`BFD` 消息的 `QOS` 标记级别默认为 7，即在网络拥塞情况下，最有限传递，尽量降低延迟，但是数据传递过程中仍会出现中间的传输延迟和设备处理延迟。

如果 `BFD` 检测参数过小，例如小于设备间的传输处理延迟，那么可能设置参数过于灵敏会导致故障误判。



华为文档建议，V200R2002C50 及之后版本，配置 `BFD` 与传输设备对接时，建议配置 `port-status fast-detect enable` 命令使能芯片快速感知接口物理状态变化功能，同时 `BFD` 检测间隔建议配置为 500ms * 4、1000ms * 3 或者 更大值。



注意本端设备的 `min-tx-interval` 小于或等于对方 `min-rx-interval`，一定要小于对方的 `min-rx-interval * detect-multiplier`。

