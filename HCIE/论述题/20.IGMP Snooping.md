# IGMP Snooping

## 1. 拓扑图

![image-20220107194020842](https://s2.loli.net/2022/01/07/YOFe4RjqNLnmPzT.png)

## 2. 题目 1

当二层设备上没有开启IGMP Snooping时，用户能否收到组播数据，请说明原因.

答：可以收到，原因如下：

1. 交换机收到流量，根据目标 `MAC` 地址的第 `8 bit` 判断是否为组播数据，如果第 `8 bit` 为 1，则为组播数据，否则为单播数据。
2. 交换机收到组播数据，默认在广播域内泛洪。

即如果二层网络 `vlan` 划分正确，在一个广播域内，正常接收到组播数据。

## 3. 题目 2

​	在当前的环境中，哪个端口属于路由端口，是如何产生的？

答：IF2 为路由端口，路由端口可以通过两种方式产生：

1. 手动指定连接 `PIM` 路由器，IGMP 查询器的三层设备为路由端口，配置如下：

   ```sql
   igmp-snooping enable			// 全局使能 igmp-snooping 功能
   igmp-snooping enable vlan 1	// 针对 vlan 1 使能 igmp-snooping 功能
   interface 2
   	igmp-snooping static-route-port vlan 1	// 指定该接口为 vlan 1 的路由接口
   ```

2. 动态学习

   IF2 接收到 `PIM hello` 报文或者 `IGMP` 查询消息，且消息的源地址非 0，那么将该接口作为路由器出口，如果已经作为路由器出口，则刷新老化计时器。

## 4. 题目 3

​	设备配置IGMP Snooping 后，导致一些用户无法收到组播数据，可能是什么原因导致（至少写出两点）

答：因为开启 `IGMP Snooping` 之后，交换机监听 `IGMP` 消息，根据生成的路由器和成员接口表项，维系 2 层组播转发表（L2-multicast forwarding-table），如果部分用户而非所有用户无法收到，可能原因如下：

1. 如果成员端口是手动指定，那么可能手动指定错误，导致 L2-multicast forwarding-table 中不存在该用户接口，无法泛洪数据。

2. 部分成员端口提前老化，导致 L2-multicast forwarding-table 中没有该用户接口。

   情况一：二层设备配置的 `igmp snooping` 查询间隔比上游查询器设置的小

   ​	本地 `igmp snooping` 设备的成员端口老化时间根据本地设置计算，如果小于上游查询间隔，则会发生本地 `igmp snooping` 成员端口提前老化，导致组播数据无法从该端口转发。

   情况二：成员端口配置快速离开功能

   ​	如果成员端口下有多个成员主机，其中一个主机发送离组消息，在开启快速离开功能时，配置如下：

   ```sql
   vlan 1
   	igmp-snooping prompt-leave
   ```

   交换机不会发送特定组查询，直接删除接口成员，导致其他成员主机接收不到组播数据。

   

