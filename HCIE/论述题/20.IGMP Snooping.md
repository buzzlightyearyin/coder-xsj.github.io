# IGMP Snooping

## 1. 拓扑图

![image-20220107194020842](https://s2.loli.net/2022/01/07/YOFe4RjqNLnmPzT.png)

## 2. 题目 1

当二层设备上没有开启IGMP Snooping时，用户能否收到组播数据，请说明原因.

答：可以收到，原因如下：

1. 交换机收到流量，根据目标 `MAC` 地址的第 `8 bit` 判断是否为组播数据，如果第 `8 bit` 为 1，则为组播数据，否则为单播数据。
2. 交换机收到组播数据，默认在广播域内泛洪。

如果二层网络 `vlan` 划分正确，在一个广播域内，正常接收到组播数据。

## 3. 题目 2

​	在当前的环境中，哪个端口属于路由器端口，是如何产生的？

答：IF2 为路由器端口，路由器端口可以通过两种方式产生：

1. 手动指定连接 `PIM` 路由器，IGMP 查询器的三层设备为路由器端口，配置如下：

   ```sql
   igmp-snooping enable			// 全局使能 igmp-snooping 功能
   igmp-snooping enable vlan 1	// 针对 vlan 1 使能 igmp-snooping 功能
   interface 2
   	igmp-snooping static-route-port vlan 1	// 指定该接口为 vlan 1 的路由接口
   ```

2. 动态学习

   IF2 接收到 `PIM hello` 报文或者 `IGMP` 普遍组查询消息，且消息的源地址非 0.0.0.0，那么将该接口作为路由器端口，并启动老化定时器，如果已经作为路由器端口，则刷新老化计时器。

## 4. 题目 3

​	设备配置IGMP Snooping 后，导致一些用户无法收到组播数据，可能是什么原因导致（至少写出两点）

答：因为开启 `IGMP Snooping` 之后，交换机监听 `IGMP` 消息，根据生成的路由器和成员接口表项，维系 2 层组播转发表（L2-multicast forwarding-table），如果部分用户而非所有用户无法收到，可能原因如下：

1. 如果成员端口是手动指定，那么可能手动指定错误，导致 L2-multicast forwarding-table 中不存在该用户接口，无法泛洪数据。

2. 部分成员端口提前老化，导致 L2-multicast forwarding-table 中没有该用户接口。

   情况一：二层设备配置的 `igmp snooping` 查询间隔比上游查询器设置的小

   ​	本地 `igmp snooping` 设备的成员端口老化时间根据本地设置计算，如果小于上游查询间隔，则会发生本地 `igmp snooping` 成员端口提前老化，导致组播数据无法从该端口转发。

   情况二：成员端口配置快速离开功能

   ​	如果成员端口下有多个成员主机，其中一个主机发送离组消息，在开启快速离开组功能时交换机不会发送特定组查询，直接删除接口成员，导致其他成员主机接收不到组播数据。

   快速离开组功能配置如下：
   
   ```sql
   vlan 1
   	igmp-snooping prompt-leave
   ```
   
   

## 题目 3 变种

第三问变种：PC1、PC2都属于VLAN 10，并且都属于同一个组播组，问PC1发送成员报告报文后，PC2是否需要发送成员报告报文。（4分）

场景一：二层交换机未开启 `IGMP-Snooping`

1、如果运行 `IGMPv1` 或 `IGMPv2` 协议，则根据不同情况分析如下：

（1）主动加组

如果 PC2 是第一次主动加组，则仍需要发送成员报告报文。

（2）响应普遍组查询消息

由于 IGMP 查询器需要通过普遍组查询维系组成员关系，当查询器发送普遍组查询消息之后，网段内所有主机都接收到该查询报文，PC1和 PC2 是组播组 G1 成员，PC1、PC2 都会随机计时器（0s-最大响应时间）

假设 PC1 计时器超时，则发送目标地址为组地址（G1）的成员报告消息，也想加入组 G1 的 PC2 侦听到此报告报文，则停止定时器，不再发送针对 G1 的成员报告报文，这样报告报文被抑制，可以减少网段上的流量。

2、如果运行 `IGMPv3` 协议，考虑到 `IGMPv3` 为 SSM 指定源模型，则 PC1 和 PC2 的源、组信息可能存在差异，同时 `IGMPv3` 报告消息的目标地址为 `224.0.0.22`，此时 PC2 仍然需要发送成员报告消息。



场景二：二层交换机开启 `IGMP Snooping`

二层交换机开启 `IGMP Snooping` 之后，IGMP Snooping 的动态成员端口表项需要借助组成员发送的报告报文来进行维系，而交换机在收到组成员发送的成员报告消息仅会向着路由器接口发送，PC 之间无法相互接收到其他组成员发送的报告消息。

因此在该场景下，PC2 无法主动加组还是被动响应查询消息，都需要发送成员报告报文。

