# 三条高可靠命令

## 第一条：stub-router on-startup

作用：stub-router命令，用来配置某路由器为stub路由器。配置了stub-router命令的路由器通过增大生成的Router LSA中链路度量值为65535，告知其它OSPF路由器不要使用它来转发数据；但是度量值不是无穷大的，因此仍然可以拥有到stub路由器的路由。

on-startup [interval]参数的作用是控制设备仅在重启或故障时保持stub-router角色，保持时间由interval决定，默认为500秒；

#### 应用场景一：存在 `OSPF` 和 `BGP` 同时部署的场景

​	用于OSPF与BGP的联动。在主备链路场景下，主链路的下一跳设备可能通过BGP学习到目的网络，当主链路故障恢复进行回切，在流量回切到主链路的过程中，IGP收敛速度比BGP快，因此OSPF先收敛，BGP还没有完成收敛，此时主链路的下一跳不知如何到达目的网络，导致流量出现丢失。使能了OSPF和BGP联动的设备在设定的时间内保持为stub路由器，即设备发出的Router LSA中的链路度量值为最大值（65535），从而告知其它OSPF路由器不要使用这个路由器来转发数据。通常将保持时间设置大于BGP收敛时间即可。

#### 应用场景二：主备链路组网升级、割接

​	用于升级或割接时。通过配置stub-router路由器，控制流量从其它链路迂回，避免升级或割接导致的影响；

## 第二条：vrrp vrid preempt-mode timer delay

作用：用来配置 VRRP 备份组中路由器的抢占延迟，默认支持抢占，抢占延迟为 0，即立即抢占。

应用场景：

#### 场景一：设备升级或者设备故障重启

​	假设 R1 和 R2 部署了 `VRRP`，并将 R1 部署成了 `Master ` 设备，承担外网流量的转发，R2 为 `Backup` 设备。当 `Master` 设备发生故障恢复后，如果立刻切换回 `Master`，这时流量切换，但是此时 `Master` 的上游路由协议还没有收敛完成，这样就会造成通信中断。所以主设备配置抢占延迟是为其它协议提供收敛时间。因此，可以在 Master 设备上开启抢占延迟，待上行链路路由协议收敛完成后，再进行抢占，从而避免流量中断。

#### 场景二：不稳定的网络

​	当网络出现抖动震荡或者拥塞等网络不稳定的情况时，可能导致 `backup `设备在 `master_down_interval ` 期间没有收到 `master `设备的报文，`backup `设备则会主动切换为 `master`。如果此时原 `master` 设备的报文又到达了，新 `master` 设备将再次切换回 `backup`。如此会出现主备频繁切换的现象。为了缓解这种现象，可以在 `backup `设备配置抢占延迟时间，在等待了 `master_down_interval `后，再等待抢占延迟时间。如果在此期间仍没有收到通告报文，`backup `设备才会切换到 `master` 设备。

## 第三条 ospf ldp-sync

作用：ospf ldp-sync命令是用来使能接口的LDP和OSPF联动功能。

应用场景：

#### 场景一：主路径故障恢复，流量回切

​	在存在主备链路的网络中，当主链路故障恢复后，流量会从备份链路切换到主链路。由于OSPF的收敛在LDP会话建立之前完成，导致旧的LSP已经删除，新的LSP还没有建立，因此LSP流量中断。LDP和IGP同步通过抑制IGP建立邻居关系来推迟路由的回切，直至LDP完成收敛。也就是说在主链路的LSP建立之前，先保留备份链路，让流量继续从备份链路转发，直至主链路的LSP建立成功，再删除备份链路。

#### 场景二：主路径 `OSPF` 协议正常，`LDP` 会话故障

​	当主链路节点间的LDP会话发生故障时，主链路上的LSP被删除，但是OSPF仍然使用主链路，同时由于备份链路上不存在OSPF优选路由，所以lsp无法在备份链路上建立，导致lsp流量持续丢失。在这种场景下，可以部署LDP和OSPF联动功能。在LDP会话故障时，LDP向OSPF通告LDP会话故障，这样OSPF就会在该链路上发布最大开销值，实现路由切换至备份链路，从而LSP也切换到备份链路。



## 共同点

共同点：三条命令都是为了保证网络收敛后再进行数据转发，提高网络的稳定性和可靠性，都可以应用在主备场景中，使主备切换更加平滑，减少网络振荡，尽可能避免业务中断。

