# MPLS LSP 隧道建立失败

## 1. 拓扑

​	![image-20220109141314690](https://s2.loli.net/2022/01/09/WpSyEsNB7THbVfI.png)

## 2. 题目 1

​	如图所示，在4台路由器使用OSPF互联互通的情况下，建立MPLS企业网LSP隧道，但发现 LSP隧道建立失败，那么影响 MPLS公网LSP的因素有哪些？（至少写出4点）

结合上述拓扑，分析影响公网LSP隧道建立的因素如下：

1. 底层 IGP 存在故障导致特定路由（传输地址）无法学习到，而通常情况下 LDP 会话建立使用传输地址，需要通过 IGP 实现可达，可以通过 `display ip routing-table protocal ospf` 检测 IGP 路由表。
2. MPLS LSR-ID 配置错误，导致 LDP 会话无法建立，默认情况下设备基于链路发现机制会使用 LSR-ID 的地址作为传输地址，可以通过 `display mpls ldp peer` 检查传输地址配置，`display mpls ldp session` 检查会话是否建立。
3. 某些设备系统视图或者接口视图缺少 `mpls/mpls ldp` 配置，可以通过 `display mpls interface` 或者 `display mpls ldp interface` 进行检查。
4. 某些设备的标签通告方式配置不一致也会影响 LDP 会话，DU 下游主动和 DOD 下游按需不同的通告方式无法建立 LDP 会话，可以通过 `dispaly mpls ldp session` 检查会话是否建立、`display mpls ldp interface` 检查接口配置。
5. 某些设备环回口地址没有配置为 `/32` 位主机地址，华为设备默认情况下仅会为 IGP 的 `/32` 位主机路由分配并通告标签。
6. 底层 IGP 如果配置多区域 OSPF，在 ABR 执行汇总也会导致 LSP 无法建立，可以通过跨域扩展 `longest-match` 解决。
7. 存在 `lsp-trigger` 等命令匹配前缀列表不为特定路由分配标签

## 3. 题目 2

​	MPLS VPN网络中，tracert命令为何不适用（中间会回显***）？

​	tracert 作为基于 ICMP 的常用故障检测工具，其工作原理具体过程如下：

​	首先 tracert 作为源节点会构造 UDP 报文，目标端口号 >= 33433，目标地址为访问测试地址，通过不断将 TTL 加 1 的方式检测经过的路径。

​	中间节点会向着源地址返回 ICMP TTL 超时消息，目标节点最终会返回 ICMP 端口不可达的消息。

​	考虑到 MPLS VPM 网络转发层面的特殊性，私网的数据报文会在公网 MPLS 域中进行转发，所以 tracert 不适用的原因分析如下：

### 原因 1：MPLS 对 TTL 的处理

1. 管道 Pipe 模式

   IP TTL 只在入节点和出节点分别减 1，而不会复制到 MPLS TTL 中，MPLS 转发过程中独立处理 TTL 值，所以可能导致 tracert 无法正常工作。

2. Uniform 一致模式

   会在入口设备将 IP TTL 复制进 MPLS TTL 中，后续 MPLS TTL 在出口设备会复制回 IP TTL 中，由于缺省情况下对 VPN 报文不使能 TTL 复制功能，如果希望将 MPLS VPN 网络中完整路径进行追踪可以配置为统一模式，执行如下命令：

   ```sql
   mpls
   	mpls propagate vpn
   ```

### 原因 2：中间节点 P 设备可能无法回应 ICMP 相应消息

​	缺省情况下，中间设备收到的 MPLS 报文只包含一层标签时，LSR 使用 IP 路由返回 ICMP 响应报文，由于没有 IP 路由出现超时情况。

​	中间节点收到的 MPLS 报文包含多层标签时， LSR 使用 LSP 返回 ICMP 响应报文。

​	针对中间节点收到 MPLS 报文只包含一层标签情况，可以通过配置命令使用 LSP 返回 ICMP 响应报文

​	执行如下命令：

  ```sql
  mpls
  	undo ttl expiration pop
  ```

## 题目 3

​	MPLS网络如何检测故障？

​	可以利用 MPLS Ping/MPLS Tracert 进行连通性检测，并及时定位失效节点。

​	上述两个工具可以利用 MPLS 回显请求 `Echo Request` 报文和 MPLS 回显应答 `Echo Reply` 报文检测 LSP 可用性，两种消息都以 UDP 报文格式发送，其中 `Echo Request` 的 UDP 端口号为 3503。

### 一、MPLS Ping 具体过程：

以 `ping lsp x.x.x.x 32` 为例，MPLS Echo  Request 会携带 FEC 信息，从而实现对 LSP 的检测。

1. Ingress  入节点查找该 LSP 是否存在，如果不存在，返回错误信息，停止 ping，如果存在，则构造 MPLS Echo Request 报文，IP 头中的目的地址为 `127.0.0.1` ，IP TTL = 1，同时将 FEC 地址填入报文中的 target FEC 中。然后查找相应的 LSP，压入相应标签，将报文发送给 Transit 节点。
2. Transit 节点对于 MPLS Echo Request 报文进行普通 MPLS 转发，如果中间节点 MPLS 转发失败，则中间节点返回带有错误码的 MPLS Echo Reply 报文。
3. 当 MPLS 转发路径没有故障，则 MPLS Echo Request 报文到达 LSP 的 Egress



### 二、MPLS Tracert 具体过程：

1. Ingress 入节点检查 LSP 是否存在，如果不存在返回错误信息，停止 tracert，如果存在，则继续构造 MPLS Echo Request 报文，IP 头中的目的地址为 `127.0.0.1` ，同时将 FEC 地址填入报文中的 target FEC 中，然后继续查找相应的 LSP，压入 LSP 的标签并将 MPLS TTL 设置为 1，将报文发送给 Tansit 节点，注意此 MPLS Echo Request 报文中包含下游映射 TLV（携带下游信息，比如下一跳地址，出标签等）。
2. Transit 节点收到上游发来的报文后，将 MPLS Echo Request TTL 减为 0 后发现 TTL 超时，然后继续检查是否存在对应的 FEC 的 LSP，分析下游映射 TLV 中的下一跳地址、出标签是否正确，如果两项检查都正确，返回正确的 MPLS Echo Reply 报文。如果检查有不正确，则返回错误的 MPLS Echo Reply 报文。
3. Ingress 入节点收到正确的 MPLS Echo Reply 报文后再次发送 MPLS Echo Request 报文，此时将 LSP 标签的 MPLS TTL 设置为 2，下游映射 TLV 中携带为 Transit 的下游信息。然后 Transit 节点收到该报文后进行普通 MPLS 转发。
4. 重复上述步骤直到 Egress 节点收到 MPLS Echo Request 报文，Egress 节点同时检查目的 FEC 中包含的目的 IP 是否为自己的接口地址，如果为自身接口地址则返回不带下游信息的 MPLS Echo Reply 报文，至此整个 MPLS Tracert 过程结束。

