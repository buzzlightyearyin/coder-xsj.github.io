# 组播目的地址的处理

## 1. 题目 1

路由器收到组播数据包目的地址是224.0.0.5和239.0.0.5的处理方式？

一、路由器收到组播数据包目标地址为 224.0.0.5 的处理方式

组播目标地址 `224.0.0.5` 为 OSPF 协议预留地址，运行了 OSPF 协议的路由器都会监听相应的组播地址，当设备收到目标地址为 `224.0.0.5` 的组播数据包之后（协议号为 89），会继续上送 CPU 交由 OSPF 处理：

​	如果路由器未启用 OSPF 协议则丢弃相应报文

​	如果路由器正确启用 OSPF 协议，则需要根据不同的网络类型处理不同的 OSPF 报文，具体分析如下：

1. 点到点类型（Point-to-Point）

   在该类型网络中，Hello 报文、DD 报文、LSR 报文、LSU 报文、LSAck 报文等报文的目标地址为 `224.0.0.5`

2. 广播类型（Broadcast）

   在该类型网络中，Hello 报文、LSU 报文、LSAck 报文等报文的目标地址为 `224.0.0.5`

3. 点到多点类型（Point-to-Multipoint）

   在该类型网络中，Hello 报文的目标地址为 `224.0.0.5`

  上述网络类型中 OSPF 收到不同报文的处理方式如下：

1.  路由器收到 Hello 报文

   会检查相应参数，参数协商失败则丢弃相应的 OSPF Hello 报文

   参数协商成功则继续通过是 `Active-Neighbor` 字段建立双向通信邻居关系，利用优先级和 `Router-id` 完成 DR、BDR 选举，后续通过参数正确的 OSPF 报文维系邻居关系并刷新超时计时器。

2.  路由器收到 DD 报文

   如果开启 MTU 检测则检测 MTU 是否一致，进一步选举主从关系保证 DD 可靠、有序交互，通过 `LSA` 头部信息完成链路状态数据库对比。

3.  路由器收到 LSR 请求报文

   收到 LSR 消息会包含对方需要请求 `LSA` 的三要素，会回应 LSU 携带相应明细 `LSA` 信息进行更新。

4.  路由器收到 LSU 更新报文

   收到 LSU 更新报文的目的地址为 `224.0.0.5`，则需要通过 LSAck 报文进行确认。

5.  路由器收到 LSAck 确认报文

   报文中携带 LSA 头部会确认之前的 LSU 是否更新成功，否则需要进行超时重传。

## 2. 题目 2

路由器收到组播数据包目标地址为239.0.0.5的处理方式

组播目的地址为 `239.0.0.5` 为本地管理组地址，通常为企业内部组播业务使用的组播地址，企业内部通常使用 `PIM `协议和 `IGMP `协议作为组播路由协议，根据上述协议构建的组播路由表项并下发到组播转发表，用于指导组播数据转发。

路由器收到组播数据包目的地址为 `239.0.0.5` 会检查是否存在相应的组播转发表，具体分析如下：

一、如果路由器不存在相应组播转发表项

​	路由器收到组播报文后没有相应的组播转发表项，会继续检查设备是否正确运行 PIM 协议或者 IGMP 协议，如果设备或者接口没有运行组播协议则会丢弃相应报文，如果设备或者接口正确运行组播协议，则需要确定设备所处组播网络位置：

1. 源端第一条路由器收到目标地址为 `239.0.0.5` 的组播报文会进行组播流量的 `RPF` 检测，`RPF` 检测失败则丢弃报文，`RPF` 检测成功会借助 PIM 协议构建组播路由条目：

   如果采用 PIM-DM 协议，则会继续将组播流量扩散至其它 PIM 邻居

   如果采用 PIM-SM 协议，则会通过单播注册消息将 （S，G）信息通知给 RP 汇聚点

   该路由器收到下游 `Join` 加入报文或者 `Prune` 剪枝报文后构建组播路由表的下游接口列表并下发组播转发表。

2. 中间路由器收到目的地址为 `239.0.0.5` 的组播报文之后首先会进行 `RPF` 检测，`RPF` 检测时报则丢弃报文，`RPF` 检测成功则会通过 PIM 协议构建组播路由条目

   该路由器收到下游 `Join` 加入报文或者 `Prune` 剪枝报文后构建组播路由表的下游接口列表并下发组播转发表。

3. 成员端口最后一条路由器通常会同时运行 IGMP 和 PIM 两个协议

   如果从上有接口收到目标地址为 `239.0.0.5` 的组播报文之后首先会进行 `RPF` 检测， `RPF` 检测时报则丢弃报文，`RPF` 检测成功则会通过 PIM 协议构建组播路由条目

   如果从成员端接口收到目的的地址为 `239.0.0.5` 的组播报文通常为 `IGMP Report` 消息，则路由器创建成员关系记录表项并创建组播路由表项

   最终将 IGMP 和 PIM 路由表项下发到组播转发表。

`RPF` 检测主要通过确定接收到组播流量的入接口与去往组播源的出接口一致，来防止组播流量的次优路由或者环路问题，`RPF` 检测时报则丢弃组播流量。其中组播静态、MBGP 组播动态、单播路由表都可以作为确定 `RPF` 接口的一句，而企业内部通常采用单播路由表作为确定 `RPF` 接口的主要依据。

二、如果路由器存在相应组播转发表项

考虑到路由器存在组播转发表项之后，为了减轻设备负担，无需针对每一份组播报文都进行 `RPF` 检测。

1. 源端和中间路由器收到目的地址为 `239.0.0.5` 的组播报文之后，收到会判断接收到组播流量的接口与组播（S，G）转发表项上游接口是否一致，如果一致则会通过组播转发表项向着下游接口列表转发该报文，如果不一致才需要进行 `RPF` 检测。

   若通过 `RPF` 选举的 `RPF` 接口与当前组播（S，G） 转发表项上游接口一致，则说明上述组播报文 `RPF` 检测失败，直接丢弃报文；

   若通过 `RPF` 选举的 `RPF` 接口与当前组播（S，G） 转发表项上游接口不一致，则说明需要更新当前组播表项上游接口，并按照更新的 `RPF` 接口对上述组播报文今昔 `RPF` 检测，检测失败则直接丢弃报文，检测通过则通过组播转发表项向着下游接口列表转发该报文。

2. 成员端最后一跳路由器如果从成员端接口收到目的地地址为 `239.0.0.5` 的组播报文通常为 IGMP Report 消息，则会刷新 IGMP 表项计时器。

