# 组播的协议和 RP 可靠性

## 1. 拓扑

![image-20220115135412297](https://s2.loli.net/2022/01/15/HJQ6hsWZtfSyqKc.png)

## 2. 题目 1

某组播网络拓扑如上，其中 MCS1 是组播源（G1），PC1 和 PC2 是组 G1 的接收者。

上述组播网络中，端口 1、2、3 需要运行哪些协议，为什么需要运行这些协议？（仅填必配的组播协议）详细写出具体原因（5 分）

答：结合上述拓扑，考虑到存在 `RP` 场景，因此运行组播路由协议为 `PIM-SM`，并且组播模型为 `ASM` 任意源模型。

一、端口 1 和 端口 2 需要运行 `IGMP` 协议和 `PIM-SM` 协议

1. 启用 `IGMP` 的原因

   端口 1 和端口 2 都连接了组成员，需要通过 `IGMP` 协议来维护组成员关系，`IGMP` 选举的查询器之后，会通过查询消息和报告消息维护相应的 `IGMP` 组表项。

   而针对当前网络中可能存在终端不支持 `IGMP` 但是相应接口仍然需要接收组流量，可以利用 `IGMP` 静态加组替代 `IGMP` 协议。

2. 启用 `PIM SM` 的原因

   首先，端口 1 和端口 2所在组成员端网络，存在多台路由器转发组播流量，如果路由器都转发组播流量会造成组成员接收到重复组播流量的问题，运行 `PIM SM` 协议之后会通过 `PIM HELLO` 报文选举 `PIM DR` 指定路由器，DR 指定路由器作为唯一的组播转发者，避免组播流量重复的问题。成员端 DR 会向着 RP 汇聚点发送（*，G）Join 报文来构建 `RPT` 共享树，并且网络稳定之后继续通过周期发送（\*，G）Join 报文维系 `RPT` 共享树。

   其次，当借口同时运行 `PIM SM` 和 `IGMP` 之后，`PIM` 协议会取代 `IGMP` 协议形成组播路由器，我们可以通过 `display pim routing-table` 来观察相应组播路由表项，便于统一管理和排障。

   最后，`PIM-SM` 选举 DR 还可以通过 `IGMPv1` 路由器的查询器，保证网络扩展性。

   需要注意的是接口下同时配置 `PIM SM` 和 `IGMP` 协议，需要保证先开启 `PIM SM` 然后在开启 `IGMP`。 

二、端口 3 需要运行 `IGMP` 协议和 `PIM-SM` 协议

1. 启用 `IGMP` 的原因

   端口 3 连接了组成员，需要通过 `IGMP` 协议来维护组成员关系，`IGMP` 选举的查询器之后，会通过查询消息和报告消息维系相应的 `IGMP` 组表项。

2. 启用 `PIM SM` 的原因

   虽然当前拓扑中只有 AR6 作为最后一条路由器，不存在组播流量冲突的问题，接口只运行 `IGMP` 也可以实现组播流量正常转发，但是考虑网络扩展性，后续如果增加组成员端路由器开启 `PIM SM` 协议之前必须删除接口 `IGMP` 配置，可能导致组播流量的丢失问题，因为建议当前拓扑中路由器所有接口都启用 `PIM SM`

   同端口 1 和端口 2 一致，接口同时配置 `PIM SM` 和 `IGMP` 协议，`PIM` 协议会取代 `IGMP` 协议形成组播路由表，便于统一管理和排障，`PIM-SM` 选举 DR 还可以通过 `IGMPv1` 路由器的查询器，保证网络扩展性。

## 3. 题目 2

在大型组播网络中，RP 如何保障可靠性，降低 RP 的负担（详细过程）（5 分）

在大型 `PIM SM` 的组播网络中，汇聚点 RP 为组播网络中一台重要的 `PIM` 路由器，因此需要保证可靠性。

考虑网络规模较大，静态 `RP` 的部署需要在网络中的所有 `PIM` 路由器上都配置相同的 `RP` 地址但是由于静态 `RP` 配置量较大，且无法感知拓扑变化，不适用于大型网络拓扑，此处考虑通过 `BSR` 机制动态选举 `RP` 保证可靠性并且降低 `RP` 负担，

我们从如下几个方案或角度来分析：

1. 配置多台 `C-RP` 并且指定服务组地址范围

   假设上述拓扑场景将部分路由器配置为 `C-RP`，同时配置多台 `C-BSR` 和 `C-RP` 都不会出现单点故障问题。

   可以继续通过配置不同 `C-RP` 服务于不同组播地址范围，实现不同组播地址选择不同的 `RP`，降低单一 `RP`的负担，配置方式如下：

   假设 R3 服务组地址范围 `239.1.1.0/24`

   ```sql
   acl 2000
   	rule 5 permit source 239.1.1.0 0.0.0.255
   pim
   	c-rp loopback0 group-policy 2000
   ```

   假设 R3 服务组地址范围 `239.1.2.0/24`

   ```sql
   acl 2000
   	rule 5 permit source 239.1.0.0 0.0.255.255
   pim
   	c-rp loopback0 group-policy 2000
   ```

   所有组地址为 `239.1.1.0/24` 业务会选择 R2 作为 RP，所有组地址 `239.1.2.0/24` 的业务会选择 R3 作为 RP，提升可靠性同时降低 RP 负担。

2. 保证开启组成员端 DR 触发切换

   华为设备默认情况下组成员端口 DR 收到第一个组播数据包后立即进行 `SPT` 切换，切换之后组播流量可以通过最优路径经由 `SPT` 源树从组播源转发至组成员。

   此时允许流量不经过 `RPT` 共享树，降低 RP 的组播流量转发负担，需要保证切换功能正常开启，不能配置永不切换。具体配置命令如下：

   ```sql
   [R2-pim]spt-switch-threshold ?
     INTEGER<1-4194304>  Value of data speed in kbps
     infinity            Never switch
   ```

3. 配置 `Anycast-RP`

   上文介绍 `C-RP` 方案中，每个组播组都只能映射到一个  `RP`，当网络流量较大、负载较重，可能导致 RP 压力过大，而 RP 失效后路由收敛较慢。

   可以应用基于 `PIM` 协议的 `Anycast RP`，可实现组播源端 DR 就近注册和组成员端 DR 就近加入，可以缓解单个 RP 的负担，也实现了 RP 备份。

   假设网络中在 R2 和 R3 上都创建环回口，配置相同的地址 `10.10.10.10` 作为 `Anycast RP`，通过底层 IGP 保证环回口地址可达，相应 `Anycast RP` 配置如下：

   ```sql
   [R2]pim
   [R2-pim]c-bsr LoopBack 0
   [R2-pim]c-rp LoopBack 0
   [R2-pim]anycast-rp 10.10.1.1
   [R2-pim-anycast-rp-10.10.1.1]local-address 2.2.2.2	// R2 本端地址
   [R2-pim-anycast-rp-10.10.1.1]peer 3.3.3.3						// R3 对端地址
   ```

