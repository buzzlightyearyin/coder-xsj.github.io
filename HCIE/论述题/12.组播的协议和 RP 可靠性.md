# 组播的协议和 RP 可靠性

## 1. 拓扑

![image-20220115135412297](https://s2.loli.net/2022/01/15/HJQ6hsWZtfSyqKc.png)

## 2. 题目 1

某组播网络拓扑如上，其中 MCS1 是组播源（G1），PC1 和 PC2 是组 G1 的接收者。

上述组播网络中，端口 1、2、3 需要运行哪些协议，为什么需要运行这些协议？（仅填必配的组播协议）详细写出具体原因（5 分）

答：结合上述拓扑，考虑到存在 `RP` 场景，因此运行组播路由协议为 `PIM-SM`，并且组播模型为 `ASM` 任意源模型。

一、采用 `PIM-SM` 和 `IGMPv1` 组合

1、2、3 接口都需要同时开启 `PIM-SM` 和 `IGMP` 协议

`PIM-SM` 协议用于 `IGMPv1` 查询器的选举，`PIM DR` 的选举、组播 RPT 树建立

`IGMP` 用于处理加组报告、维护组成员关系。

二、采用 `PIM-SM` 和 `IGMPv2` 组合

1、2 接口需要同时开启 `PIM-SM` 和 `IGMP` 协议，3 接口仅需要开启 `IGMP` 协议

`PIM-SM` 协议用于`PIM DR` 的选举、组播 RPT 树的构建

`IGMP` 用于处理加组报告、维护组成员关系。

需要注意的是后续 3 接口需要连接 MA 网络，存在多台路由器可能则必须开启 `PIM-SM` 协议。

三、采用 `PIM-IPv6-SM` 和 `MLD` 组合

1、2 接口需要同时开启 `PIM-IPv6-SM` 和 `MLD` 协议，3 接口仅需要开启 `MLD` 协议

`PIM-IPv6-SM` 是用于 `PIM IPV6 DR` 的选举，组播 RPT 树建立

`MLD` 用于处理加组报告、维护组成员关系

针对部分主机不支持 `IGMP` 或者希望快速转发组播流量的场景，接口也可以配置 `IGMP` 或 `MLD` 静态加组。

## 3. 题目 2

在大型组播网络中，RP 如何保障可靠性，降低 RP 的负担（详细过程）（5 分）

在大型 `PIM SM` 的组播网络中，汇聚点 RP 为组播网络中一台重要的 `PIM` 路由器，因此需要保证可靠性。

考虑网络规模较大，静态 `RP` 的部署需要在网络中的所有 `PIM` 路由器上都配置相同的 `RP` 地址但是由于静态 `RP` 配置量较大，且无法感知拓扑变化，不适用于大型网络拓扑，此处考虑通过 `BSR` 机制动态选举 `RP` 保证可靠性并且降低 `RP` 负担，

我们从如下几个方案或角度来分析：

方案一：配置多台 `C-RP` 并且指定服务组地址范围

假设上述拓扑场景将部分路由器配置为 `C-RP`，同时配置多台 `C-BSR` 和 `C-RP` ，保证 `C-BSR` 和 `C-RP` 都不会出现单点故障问题。

可以继续通过配置不同 `C-RP` 服务于不同组播地址范围，实现不同组播地址选择不同的 `RP`，降低单一 `RP`的负担，配置方式如下：

假设 R3 服务组地址范围 `239.1.1.0/24`

```sql
acl 2000
	rule 5 permit source 239.1.1.0 0.0.0.255
pim
	c-rp loopback0 group-policy 2000
```

假设 R3 服务组地址范围 `239.1.2.0/24`

```sql
acl 2000
	rule 5 permit source 239.1.2.0 0.0.0.255
pim
	c-rp loopback0 group-policy 2000
```

所有组地址为 `239.1.1.0/24` 业务会选择 R2 作为 RP，所有组地址 `239.1.2.0/24` 的业务会选择 R3 作为 RP，提升可靠性同时降低 RP 负担。

方案二：保证开启组成员端 DR 触发切换

华为设备默认情况下组成员端口 `DR` 收到第一个组播数据包后立即进行 `SPT` 切换，切换之后组播流量可以通过最优路径经由 `SPT` 源树从组播源转发至组成员。

此时允许流量不经过 `RPT` 共享树，降低 RP 的组播流量转发负担，需要保证切换功能正常开启，不能配置永不切换。具体配置命令如下：

```sql
[R2-pim]spt-switch-threshold ?
  INTEGER<1-4194304>  Value of data speed in kbps
  infinity            Never switch
```

方案三：配置 `Anycast-RP`

上文介绍 `C-RP` 方案中，每个组播组都只能映射到一个  `RP`，当网络流量较大、负载较重，可能导致 `RP `压力过大，而 `RP `失效后路由收敛较慢。

可以应用基于 `PIM` 协议的 `Anycast RP`，可实现组播源端 `DR `就近注册和组成员端 `DR ` 就近加入，可以缓解单个 RP 的负担，也实现了 RP 备份。

假设网络中在 R2 和 R3 上都创建环回口，配置相同的地址 `10.10.10.10` 作为 `Anycast RP`，通过底层 IGP 保证环回口地址可达，相应 `Anycast RP` 配置如下：

```sql
pim
  c-bsr LoopBack 0
  c-rp LoopBack 0
  anycast-rp 10.10.1.1
    local-address 2.2.2.2	  // R2 本端地址
    peer 3.3.3.3						// R3 对端地址
```

