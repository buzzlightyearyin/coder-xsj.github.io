# 三条高可靠命令

## 第一条：ospf ldp-sync

作用：该命令主要针对 `IGP` 和 `LDP` 联动的场景，解决因为 `OSPF` 协议与 `LDP` 协议收敛不一致而导致的流量丢失问题，用于提升网络可靠性。

应用场景：

#### 场景一：主路径故障恢复，流量回切

​	假设通过 A 节点与目标节点之间有多条冗余链路，当主链路发生故障时， A 节点的 `OSPF` 和 `LSP` 链路均会切换到备份链路上，依旧可以正常转发数据。这时当主链路从故障中恢复时，由于 `LDP` 的收敛速度比 `OSPF` 的收敛速度慢，`OSPF` 会先于 `LDP` 完成收敛切回主路径，因此可能造成 `LSP` 流量丢失。

#### 场景二：主路径 `OSPF` 协议正常，`LDP` 会话故障

​	假设 A 节点主链路的 `OSPF` 运行正常，但主链路的 `LDP` 会话发生故障时，此时 `OSPF` 路由仍然使用主链路进行转发，而主链路的 `LSP` 则会被删除。同时由于备份链路的 `OSPF` 路由在此时不是最优路由，所以最终导致 `LSP` 无法在备份链路正常建立，导致 `LSP` 数据流量丢失。

上述场景产生的问题可以执行 `ospf ldp-sync` 使能 `LDP` 和 `OSPF` 联动功能来进行解决，避免流量丢失的情况。

针对场景一的问题：OSPF 会抑制邻居关系正常建立等待 `LDP` 会话建立完成。

针对场景二的问题：主路径 `LDP` 出现故障后，OSPF 会发布最大开销值，从而实现流量切换到备份路径。

## 第二条：vrrp vrid preempt-mode timer delay

作用：上述命令通过配置 `VRRP Master` 设备的抢占时间延时来提升网络的稳定性，防止主备设备频繁切换导致的流量丢失问题。

应用场景：

#### 场景一：不稳定的网络

​	当网络出现抖动震荡或者拥塞等网络不稳定的情况时，`Backup` 可能在一定时间段内没有收到来自 `Master` 的报文，`Backup` 就会抢占成为 `Master`，这样会导致 `VRRP` 状态频繁转换，从而造成数据流量丢失。此时根据网络实际情况在 `Master` 设备上合理配置抢占延迟时间，使 `Backup` 延迟一段时间后成为 `Master` ，可以有效的避免 `VRRP` 状态频繁发生转换。

#### 场景二：设备升级或者设备故障重启

​	当 `VRRP` 的 `Master` 设备因设备升级或设备故障重启而恢复的时候，如果底层的相关路由协议有可能还未完成收敛，此时进行切换，可能会导致数据流量的丢失，此问题可以在 `Master` 设备上配置抢占时延，让其需要等待 `Master` 设备上相关的路由协议先完成收敛，在进行 `VRRP` 抢占切换的时候，可以有效的避免由于底层协议未完成收敛而带来的丢包问题。

## 第三条：stub-router on-startup

作用：设备在故障重启或升级重启时，配置上述命令之后 `OSPF` 会在一定时间内保持发布最大开销值，从而暂时将设备从网络中独立出来，避免影响底层数据转发，便于完成设备故障修复、升级等工作。

#### 应用场景一：存在 `OSPF` 和 `BGP` 同时部署的场景

​	当网络中存在主备冗余链路的场景，当主链路设备故障重启或升级重启之后，`OSPF` 可能先于 `BGP` 完成收敛，导致 `BGP` 黑洞问题出现，流量丢失的情况。

​	若配置了 `stub-router on-startup`，此时在设备重启之后，让设备保持 `stub-router` 状态，此时该路由器通告出去的 `LSA cost` 值为 `65535`，这样数据就不会经过该路由，当计时器到期、`BGP` 完成收敛之后，恢复成普通路由器，完成路由计算，重新正常稳定的数据转发。 

#### 应用场景二：主备链路组网升级、割接

​	在主备链路的组网中，升级、割接时，通过配置 `stub-router on-startup` 命令，控制流量从其他链路迂回，尽量避免升级、割接导致的影响，避免升级、割接业务流量中断。

## 共同点

通过上述分析认为：

1. 三条命令都考虑到了网络部署时各协议的相互影响，无论是链路主备切换，还是设备升级或设备故障重启后的设备切换等场景，都是尽量延迟故障恢复后的切换等待时间，保证能够稳定切换后在进行网络切换，防止数据丢失。
2. 三条命令都是为了保证网络中各协议的一致性，在网络拓扑中存在主备冗余的场景中，上述配置命令也可以配合使用，尽量避免流量丢失，从而提升整个网络的可靠性及稳定性。



